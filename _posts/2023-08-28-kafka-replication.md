---
layout: post
title: "Kafka의 리더/팔로워와 리플리케이션"
date: 2023-08-28
excerpt: "Kafka가 장애에 대비하는 방법"
tags: [kafka, backend]
comments: true
---

## Kafka의 동작방식

카프카의 핵심 구성요소는 다음과 같다. (카프카의 동작방식을 이해하기 위한 내용이므로 zookeeper를 비롯한 다른 구성요소는 생각하지 않는다.)

* Producer(생산자)
* Kafka Cluster(카프카 클러스터)
* Consumer(소비자)

이들 중 카프카 클러스터를 구성하는 '카프카 브로커(메시지 브로커)'를 자세히 볼 필요가 있다. 

<img width="803" alt="image" src="https://github.com/MinChangJeong/minchangjeong.github.io/assets/65451455/3e2dc1b6-9599-4e37-9ad9-e957247849b1">

위 그림은 카프카의 동작 방식에 대해 내가 이해하는데 가장 큰 도움을 줬던 그림이다. 카프카 클러스터를 구성하고 잇는 3개의 브로커를 보자. (일반적으로 카프카 클러스터는 default로 3개의 브로커를 구성하는데 이는 카프카의 고가용성 때문이다.)

카프카 브로커 또는 메시지 브로커는 하나의 서버로써 동작을 한다. 즉, 각 브로커는 각각의 IP를 갖고 있다. 때문에 카프카가 **데이터의 분산 저장과 복제**를 통해 고가용성과 내구성을 보장할 수 있다. 방금 말한 데이터의 분산 저장과 복제가 어떻게 이뤄지는지 아래에서 주의 깊게 살펴보자. (내가 매우 헷갈렸던 지점인기 때문이다.)

카프카의 동작 원리를 이해하기 위해 몇 가지 특징들을 정리하자. 

* 생산자는 토픽을 생성한다. 
* 생산자와 토픽의 관계는 마치 유튜버와 유튜브 채널과 같은 관계이다. 
* 소비자는 토픽을 구독한다. 
* 소비자와 토픽의 관계는 마치 유튜브 채널과 채널을 구독한 사용자 같은 관계이다.
* 하나의 토픽에 대해 여러 파티션을 구성한다. 

정리하자면 생산자 - 토픽 - 소비자는 Pub/Sub 구조를 갖는다. 핵심은 생산자는 메시지나 이벤트를 생성해서 토픽에게 전달하고, 소비자는 토픽을 구독하면서 메시지나 이벤트를 수신하다는 것이다.

생성자는 **토픽**에게 생성한 메시지나 이벤트를 전달한다고 했습니다. 그리고 전달된 메시지나 이벤트는 **파티션**에 저장됩니다.

파티션은 리더 파티션과 팔로워 파티션으로 구성되고 팔로워 파티션은 리더 파티션을 복제한다. 

## 카프카의 리더, 팔로워와 Replication(복제)

<img width="714" alt="image" src="https://github.com/MinChangJeong/minchangjeong.github.io/assets/65451455/1013623f-37b4-4223-b282-9908ead33fa9">

그림을 요약하면 다음과 같다. 

* 카프카 브로커 3대로 카프카 클러스터를 이루고 있다. 
* 하나의 토픽에 대해 파티션 4개로 구성되어 있다. 

파티션들은 어떤 브로커에서 리더가 될지 모른다. 리더 파티션의 선출은 주키퍼(Zookeeper)의 역할이기 때문이다. 핵심은 리더 파티션을 팔로워 파티션이 복제함으로써 장애에 대비한다는 점이다. 

카프카에서 분산처리를 하기 위해 모든 브로커에 데이터를 동일하게 보내는 것이 아니라 리더가 팔로워에 복제를 한다. 위의 그림 처럼 말이다. 

위의 그림 같이 카프카 클러스터가 구성되는 경우 어떻게 프로듀서가 생성한 메시지가 파티션에 전달되는지 알아보자. 

파티션 할당은 카프카 내부의 분배 알고리즘에 의해 결정된다. 프로듀서가 메시지를 특정 파티션에 보낼 때는 메시지의 키(Key)를 사용하거나 라운드로빈 방식 등의 분배 로직을 활용할 수 있다. 즉 해당 프로커의 리더 파티션 중 하나로 메시지가 라우팅 된다. 

예를 들어 토픽 A에 대해 리더 브로커가 2번째 브로커인 경우 리더 파티션은 파티션0과 파티션 3이라고 가정하자. 프로듀서가 메시지를 토픽 A로 보낼 때 메시지의 키를 사용해 파티션을 선택하면 해당 키를 해싱하여 파티션 0또는 파티션 3중 하나의 파티션으로 메시지가 전달된다. 
















